<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: CQ5-AEM | IT Gumby]]></title>
  <link href="http://ItGumby.github.io/blog/categories/cq5-aem/atom.xml" rel="self"/>
  <link href="http://ItGumby.github.io/"/>
  <updated>2014-10-11T23:23:25-06:00</updated>
  <id>http://ItGumby.github.io/</id>
  <author>
    <name><![CDATA[Brian Street]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[CQ Queries Demystified]]></title>
    <link href="http://ItGumby.github.io/blog/2014/10/cq-queries-demystified/"/>
    <updated>2014-10-09T18:36:00-06:00</updated>
    <id>http://ItGumby.github.io/blog/2014/10/cq-queries-demystified</id>
    <content type="html"><![CDATA[<p>The JCR (Java Content Repository) is a data-store at its heart.  Most examples around it demonstrate either building components or walking the Node tree.  It is hard to find examples around queries and the JCR.  To make things worse, we have a number of options and little resourcs to compare them.  My humble goal is to make JCR queries less scary &ndash; to myself and others.</p>

<p>== Why Use Queries?</p>

<p>I see 2 primary benefits to using queries compared to &ldquo;walking the nodes&rdquo;: efficiency and flexibility.</p>

<p>Queries can be <em>more efficient</em> when the desired nodes/pages are &ldquo;sparse&rdquo;.  By sparse, I mean you have to visit a lot more nodes than you keep.  In my recent experience, I was looking for approximately 200-300 pages out of 2,000.  Converting from page traversal to a query improved performance by an order of magnitude (from approximately 10 sec. to well under a second.)</p>

<p>Queries also permit <em>flexibility in structure</em>.  <a href="http://wiki.apache.org/jackrabbit/DavidsModel#Rule_.231">http://wiki.apache.org/jackrabbit/DavidsModel#Rule_.231</a>[David&rsquo;s Rules] encourage prioritizing content over formal structure.  If walking the tree of nodes or pages, a developer may limit depth of searching (either a flat level or limited recursion) for simplicity of code and/or performance.  However, in a CMS environment, there are tremendous benefits for authors when they can create an arbitrary taxonomy around their data or pages.</p>

<p>There are two primary APIs for Querying in CQ5:</p>

<ul>
<li><code>javax.jcr.query</code> provides a query interface API in a variety of syntaxes.  <a href="http://www.day.com/specs/javax.jcr/javadocs/jcr-2.0/javax/jcr/query/QueryResult.html">http://www.day.com/specs/javax.jcr/javadocs/jcr-2.0/javax/jcr/query/QueryResult.html</a>[QueryResult] can return <a href="http://www.day.com/specs/javax.jcr/javadocs/jcr-2.0/javax/jcr/NodeIterator.html">http://www.day.com/specs/javax.jcr/javadocs/jcr-2.0/javax/jcr/NodeIterator.html</a>[NodeIterators] or <a href="http://www.day.com/specs/javax.jcr/javadocs/jcr-2.0/javax/jcr/query/RowIterator.html">http://www.day.com/specs/javax.jcr/javadocs/jcr-2.0/javax/jcr/query/RowIterator.html</a>[RowIterators] (where a <a href="http://www.day.com/specs/javax.jcr/javadocs/jcr-2.0/javax/jcr/query/Row.html">http://www.day.com/specs/javax.jcr/javadocs/jcr-2.0/javax/jcr/query/Row.html</a>[Row] can have 1 or more columns. Columns can be +<a href="http://www.day.com/specs/javax.jcr/javadocs/jcr-2.0/javax/jcr/Node.html">http://www.day.com/specs/javax.jcr/javadocs/jcr-2.0/javax/jcr/Node.html</a>[Node]+ node,  +<a href="http://www.day.com/specs/javax.jcr/javadocs/jcr-2.0/javax/jcr/Value.html">http://www.day.com/specs/javax.jcr/javadocs/jcr-2.0/javax/jcr/Value.html</a>[Value]+ property, +String+ path or +double+ score).</li>
<li><code>com.day.cq.search</code> provides both a REST interface and an API.  The <a href="http://docs.adobe.com/docs/en/aem/6-0/develop/ref/javadoc/com/day/cq/search/result/SearchResult.html">http://docs.adobe.com/docs/en/aem/6-0/develop/ref/javadoc/com/day/cq/search/result/SearchResult.html</a>[SearchResult] can return +Iterator<Resource>+, +Iterator<Node>+, or +List<a href="http://docs.adobe.com/docs/en/aem/6-0/develop/ref/javadoc/com/day/cq/search/result/ResultPage.html[ResultPage]">http://docs.adobe.com/docs/en/aem/6-0/develop/ref/javadoc/com/day/cq/search/result/ResultPage.html[ResultPage]</a>+ that match the Predicates.</li>
</ul>


<p>=== Preconditions</p>

<p>CQ5 searches are &ldquo;powered by&rdquo; <a href="http://lucene.apache.org/">http://lucene.apache.org/</a>[Apache Lucene] (although AEM6 is converting to <a href="http://lucene.apache.org/solr/">http://lucene.apache.org/solr/</a>[Apache Solr]).  An important limitation is that indexing only examines Node properties that are 16KB or less in size &ndash; so anything larger won&rsquo;t be found by any searching mechanism.</p>

<p>Internally, the queries are converted to an AQM (Abstract Query Model).  The interesting aspect about AQM is the ability to create new query syntaxes and predicates &ndash; but that is well beyond the scope of this post.</p>

<p>=== NodeTypes</p>

<p>I recommend paying attention to the <a href="http://jackrabbit.apache.org/node-type-visualization.html">http://jackrabbit.apache.org/node-type-visualization.html</a>[NodeType] you use.  At the top of the hierarchy tree is <code>nt:base</code>, (so all nodes inherit from it).  Because of this inheritance, most examples show using it as a &ldquo;works anywhere&rdquo; approach.  However, I feel this is a poor approach and you would be better served selecting a more appropriate type (<code>jcr:primaryType</code> property of your desired nodes).  I would like to highlight:</p>

<ul>
<li><code>cq:Page</code> to match just <a href="http://dev.day.com/docs/en/cq/current/javadoc/com/day/cq/wcm/api/Page.html">http://dev.day.com/docs/en/cq/current/javadoc/com/day/cq/wcm/api/Page.html</a>[Page] nodes</li>
<li><code>cq:PageContent</code> to easily convert to <a href="http://dev.day.com/docs/en/cq/current/javadoc/com/day/cq/commons/inherit/InheritanceValueMap.html">http://dev.day.com/docs/en/cq/current/javadoc/com/day/cq/commons/inherit/InheritanceValueMap.html</a>[InheritanceValueMap] or <a href="http://dev.day.com/docs/en/cq/current/javadoc/org/apache/sling/api/resource/ValueMap.html">http://dev.day.com/docs/en/cq/current/javadoc/org/apache/sling/api/resource/ValueMap.html</a>[ValueMap]</li>
<li><code>nt:unstructured</code> to find content nodes for generic components or content</li>
</ul>


<p>== JCR Queries: <a href="http://www.day.com/specs/javax.jcr/javadocs/jcr-2.0/javax/jcr/query/Query.html">http://www.day.com/specs/javax.jcr/javadocs/jcr-2.0/javax/jcr/query/Query.html</a>[+javax.jcr.query+]</p>

<p>[cols=&ldquo;1,2,2&rdquo;, options=&ldquo;header&rdquo;]
.jcr.query Syntaxes
|===
|Syntax
|Cons
|Pros</p>

<p>|<a href="http://jackrabbit.apache.org/api/2.2/org/apache/jackrabbit/commons/query/sql2/package-summary.html">http://jackrabbit.apache.org/api/2.2/org/apache/jackrabbit/commons/query/sql2/package-summary.html</a>[SQL2]
|poor documentation +
no sub-queries +
limited joins +
new functions
|&ldquo;looks&rdquo; like a query +
limited joins (K.I.S.S. principle)</p>

<p>|<a href="http://jackrabbit.apache.org/api/2.2/org/apache/jackrabbit/spi/commons/query/xpath/package-summary.html">http://jackrabbit.apache.org/api/2.2/org/apache/jackrabbit/spi/commons/query/xpath/package-summary.html</a>[XPath]
|&ldquo;strange&rdquo; syntax (<a href="http://zvon.org/comp/r/tut-XPath_1.html#intro">http://zvon.org/comp/r/tut-XPath_1.html#intro</a>[Tutorials exist]) +
deprecated in JCR2.0 (yet still supported) +
many XPath functions missing
|maturity &amp; performance +
generic (outside JCR) solution for structure/nodes/attributes</p>

<p>|<a href="http://www.day.com/maven/javax.jcr/javadocs/jcr-2.0/javax/jcr/query/qom/QueryObjectModelFactory.html?is-external=true">http://www.day.com/maven/javax.jcr/javadocs/jcr-2.0/javax/jcr/query/qom/QueryObjectModelFactory.html?is-external=true</a>[JQOM]
|poor documentation
|build own query language/API</p>

<p>|SQL
|no longer supported
|N/A
|===</p>

<p>.Query Example</p>

<h2>[source,jsp]</h2>

<h2>include::source/_posts/jcr.query.jsp[]</h2>

<p>TIP: Prefer +Resource+ over +Node+.  It has a cleaner, easier to use API.</p>

<p>TIP: Leverage JSP Expression Language &amp; <a href="http://www.tutorialspoint.com/jsp/jsp_standard_tag_library.htm">http://www.tutorialspoint.com/jsp/jsp_standard_tag_library.htm</a>[JSTL] to keep the JSP Template simple &amp; clear.</p>

<p>== QueryBuilder API: <a href="http://docs.adobe.com/docs/en/cq/current/javadoc/com/day/cq/search/package-summary.html">http://docs.adobe.com/docs/en/cq/current/javadoc/com/day/cq/search/package-summary.html</a>[+com.day.cq.search+]</p>

<p>[cols=&ldquo;1,2,2&rdquo;, options=&ldquo;header&rdquo;]
.QueryBuilder Syntaxes
|===
|Syntax
|Cons
|Pros</p>

<p>| <a href="http://docs.adobe.com/docs/en/aem/6-0/develop/ref/javadoc/com/day/cq/search/QueryBuilder.html">http://docs.adobe.com/docs/en/aem/6-0/develop/ref/javadoc/com/day/cq/search/QueryBuilder.html</a>[Java API]
| More code to setup +
node property values must be extracted (just like JCR Queries)
| Iterators for Resources, Nodes (your choice) +
Lists of Pages (natural for search results pages) +
Predicates make &ldquo;sense&rdquo; as search conditions</p>

<p>| &ldquo;RESTful&rdquo; interface at <a href="http://docs.adobe.com/docs/en/aem/6-0/develop/search/querybuilder-api.html">http://docs.adobe.com/docs/en/aem/6-0/develop/search/querybuilder-api.html</a>[/bin/querybuilder.json]
| grouping predicates is more complex (naming predicates)
| dynamic at runtime +
documented examples of multi properties/values/nesting +
easy to test/explore via browser, +curl+
|===</p>

<p>.Query Example</p>

<h2>[source,jsp]</h2>

<h2>include::source/_posts/cq.search.jsp[]</h2>

<p>TIP: JSPs are best kept as templates with little to no Java in them.  In practice,
move the Java to an OSGi-managed class (Model).  If built outside of CQ5, this permits
rapid unit testing and potentially other JVM languages such as groovy.</p>

<p>REST Example: <a href="http://localhost:4502/bin/querybuilder.json?type=cq:Component&amp;path=/apps&amp;orderby=@title&amp;orderby.sort=asc">http://localhost:4502/bin/querybuilder.json?type=cq:Component&amp;path=/apps&amp;orderby=@title&amp;orderby.sort=asc</a></p>

<p>== Other Resources</p>

<ul>
<li><a href="https://wiki.magnolia-cms.com/display/WIKI/JCR+Query+Cheat+Sheet">https://wiki.magnolia-cms.com/display/WIKI/JCR+Query+Cheat+Sheet</a>[JCR+Query+Cheat+Sheet] for comparing syntaxes</li>
<li><a href="http://labs.sixdimensions.com/blog/2014-10-07/9-jcr-sql-2-queries-every-aem-dev-should-know/">http://labs.sixdimensions.com/blog/2014-10-07/9-jcr-sql-2-queries-every-aem-dev-should-know/</a>[9 JCR-SQL2 Queries Every AEM Developer Should Know] by Dan Klco</li>
<li><a href="http://helpx.adobe.com/experience-manager/kb/HowToDebugJCRQueries.html">http://helpx.adobe.com/experience-manager/kb/HowToDebugJCRQueries.html</a>[HowToDebugJCRQueries.html]
discusses adding loggers to a new file (separate from standard error.log) at the DEBUG level.
This logs the queries executed and their execution time.</li>
</ul>


<p>=== SQL2 functions (from <a href="http://www.day.com/specs/jcr/2.0/6_Query.html#6.6.2%20JCR-SQL2%20Notation">http://www.day.com/specs/jcr/2.0/6_Query.html#6.6.2%20JCR-SQL2%20Notation</a>[JCR v2.0 Spec])</p>

<ul>
<li>CONTAINS(<em>propName</em>, <em>value</em>)</li>
<li>ISCHILDNODE() <em>immediate relationship</em></li>
<li>ISDESCENDANTNODE() <em>nested relationship</em></li>
<li>ISSAMENODE() <em>for join conditions</em></li>
<li>LENGTH(<em>propName</em>)</li>
<li>NAME()</li>
<li>LOCALNAME()</li>
<li>LOWER() <em>lower case the text</em></li>
<li>UPPER() <em>upper case the text</em></li>
<li>SCORE()</li>
<li>CAST(<em>literal</em> AS <em>type</em>)</li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[CQ5 resource - &lt;cq:defineObjects/> CheatSheet]]></title>
    <link href="http://ItGumby.github.io/blog/2014/02/cq-defineObjects-cheatsheet/"/>
    <updated>2014-02-16T20:14:00-07:00</updated>
    <id>http://ItGumby.github.io/blog/2014/02/cq-defineObjects-cheatsheet</id>
    <content type="html"><![CDATA[<p><a href="https://dev.day.com/docs/en/cq/current/developing/components.html#%3Ccq:defineObjects%3E">https://dev.day.com/docs/en/cq/current/developing/components.html#%3Ccq:defineObjects%3E</a>[CQ5 Developing Components]
has a lot of information, but I wanted a handier cheat sheet.</p>

<p>.Objects from &lt;cq:defineobjects/> (as of CQ5.6)
|===
|Name | JavaDoc | Description | my favorite methods</p>

<p>|<code>component</code></p>

<pre><code>| http://dev.day.com/docs/en/cq/current/javadoc/index.html?com/day/cq/wcm/api/components/Component.html[Component]
| the current AEM component object of the current resource
| getName() / getPath()
</code></pre>

<p>|<code>componentContext</code></p>

<pre><code>|http://dev.day.com/docs/en/cq/current/javadoc/index.html?com/day/cq/wcm/api/components/ComponentContext.html[ComponentContext]
|the current component context object of the request
| getPage() / getResource() / setDecorate(boolean)
</code></pre>

<p>|<code>currentDesign</code></p>

<pre><code>| http://dev.day.com/docs/en/cq/current/javadoc/com/day/cq/wcm/api/designer/Design.html[Design]
| the current design object of the current page
| getStaticCssPath() / getStyle(\_) / writeCss(Writer, boolean) / writeCssIncludes(_)
</code></pre>

<p>|<code>currentPage</code></p>

<pre><code>| http://dev.day.com/docs/en/cq/current/javadoc/com/day/cq/wcm/api/Page.html[Page]
| the current AEM WCM page object
| getName() / getTitle() / getNavigationTitle() / getTags() / getContentResource() / getDepth() / getPageManager()
</code></pre>

<p>|<code>currentStyle</code></p>

<pre><code>| http://dev.day.com/docs/en/cq/current/javadoc/com/day/cq/wcm/api/designer/Style.html[Style]
| the current style object of the current cell
| -
</code></pre>

<p>|<code>designer</code></p>

<pre><code>| http://dev.day.com/docs/en/cq/current/javadoc/com/day/cq/wcm/api/designer/Designer.html[Designer]
| the designer object used to access design information
| getDesign(\_) / getStyle(_)
</code></pre>

<p>|<code>editContext</code></p>

<pre><code>| http://dev.day.com/docs/en/cq/current/javadoc/com/day/cq/wcm/api/components/EditContext.html[EditContext]
| the edit context object of the AEM component
| -
</code></pre>

<p>|<code>pageManager</code></p>

<pre><code>| http://dev.day.com/docs/en/cq/current/javadoc/com/day/cq/wcm/api/PageManager.html[PageManager]
| the page manager object for page level operations
| getPage(path) / create/ copy/ delete/ move/ order(\_) / getRevisions(_)
</code></pre>

<p>|<code>pageProperties</code></p>

<pre><code>| http://dev.day.com/docs/en/cq/current/javadoc/com/day/cq/commons/inherit/InheritanceValueMap.html[InheritanceValueMap]
| the page properties object of the current page
| getInherited(name,default) / get(name,default) / put(key,val)
</code></pre>

<p>|<code>properties</code></p>

<pre><code>| http://dev.day.com/docs/en/cq/current/javadoc/org/apache/sling/api/resource/ValueMap.html[ValueMap]
| the properties object of the current resource
| get(name,defaultVal) / put(key,val) http://experiencedelivers.adobe.com/cemblog/en/experiencedelivers/2013/02/valuemap-and-his-friend.html[examples]
</code></pre>

<p>|<code>resourceDesign</code></p>

<pre><code>| http://dev.day.com/docs/en/cq/current/javadoc/com/day/cq/wcm/api/designer/Design.html[Design]
| the design object of the resource page
| _see currentDesign_
</code></pre>

<p>|<code>resourcePage</code></p>

<pre><code>| http://dev.day.com/docs/en/cq/current/javadoc/com/day/cq/wcm/api/Page.html[Page]
| the resource page object
| _see currentPage_
</code></pre>

<p>|===</p>

<p>Attributes provided by <code>cq:defineObjects</code>:</p>

<ul>
<li><code>componentContextName</code></li>
<li><code>componentName</code></li>
<li><code>currentDesignName</code></li>
<li><code>currentPageName</code></li>
<li><code>currentStyleName</code></li>
<li><code>designerName</code></li>
<li><code>editContextName</code></li>
<li><code>logName</code></li>
<li><code>nodeName</code></li>
<li><code>pageManagerName</code></li>
<li><code>pagePropertiesName</code></li>
<li><code>propertiesName</code></li>
<li><code>requestName</code></li>
<li><code>resourceDesignName</code></li>
<li><code>resourceName</code></li>
<li><code>resourcePageName</code></li>
<li><code>resourceResolverName</code></li>
<li><code>slingName</code></li>
</ul>


<p>The &lt;cq:defineObjects> tag also automatically includes &lt;sling:defineObjects/></p>

<p>.Objects from &lt;sling:defineObjects/> (as of CQ5.6)
|===
|Name | JavaDoc | Description | my favorite methods</p>

<p>|<code>currentNode</code></p>

<pre><code>| http://www.day.com/maven/javax.jcr/javadocs/jcr-1.0/javax/jcr/Node.html[Node]
| JCR node for current resource (not defined if not)
| _discourage in favor of Resource or ValueMap_ addNode(_) / getUUID()
</code></pre>

<p>|<code>log</code></p>

<pre><code>| http://www.slf4j.org/api/org/slf4j/Logger.html[SLF4J.Logger]
| Provides an SLF4J Logger for logging to the Sling log system from within scripts
| error / warn / info / debug
</code></pre>

<p>|<code>resource</code></p>

<pre><code>| http://dev.day.com/docs/en/cq/current/javadoc/org/apache/sling/api/resource/Resource.html[Resource]
| the current Resource object to handle (depending on the URL of the request)
| getName() / getPath() / getChild(path) / getChildren()
</code></pre>

<p>|<code>resourceResolver</code></p>

<pre><code>| http://dev.day.com/docs/en/cq/current/javadoc/org/apache/sling/api/resource/ResourceResolver.html[ResourceResolver]
| The current ResourceResolver object
| create(args) / commit() / getResource(\_) / resolve(_) / queryResources(query, lang)
</code></pre>

<p>|<code>sling</code></p>

<pre><code>| http://dev.day.com/docs/en/cq/current/javadoc/index.html?org/apache/sling/api/scripting/SlingScriptHelper.html[SlingScriptHelper]
| convenience methods for scripts.  GOD Object.
| getService(Class) / include(\_) / forward(_) / getRequest() / getResponse() / getScript()
</code></pre>

<p>|<code>slingRequest</code></p>

<pre><code>| http://dev.day.com/docs/en/cq/current/javadoc/org/apache/sling/api/SlingHttpServletRequest.html[SlingHttpServletRequest]
| extends http://docs.oracle.com/javaee/1.4/api/javax/servlet/http/HttpServletRequest.html[HttpServletRequest]
| getResource() / getCookie(name) / getRequestParameterMap() / getRequestParameters(name) / getRequestPathInfo()
</code></pre>

<p>|<code>slingResponse</code></p>

<pre><code>| http://dev.day.com/docs/en/cq/current/javadoc/org/apache/sling/api/SlingHttpServletResponse.html[SlingHttpServletResponse]
| extends http://docs.oracle.com/javaee/1.4/api/javax/servlet/http/HttpServletResponse.html[HttpServletResponse]
| static fields / addCookie(cookie) / getOutputStream() / getWriter()
</code></pre>

<p>|===</p>

<p>Attributes provided by <code>sling:defineObjects</code>:</p>

<ul>
<li><code>logName</code></li>
<li><code>nodeName</code></li>
<li><code>requestName</code></li>
<li><code>resourceResolverName</code></li>
<li><code>responseName</code></li>
<li><code>slingName</code></li>
</ul>


<p>I hope this helps others and myself.</p>
]]></content>
  </entry>
  
</feed>
