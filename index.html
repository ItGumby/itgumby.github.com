<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <title>IT Gumby's blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="Brian Street">
    <meta name="keywords" content="">
    <meta name="generator" content="JBake">

    <!-- Le styles -->
    <link href="/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/asciidoctor.css" rel="stylesheet">
    <link href="/css/base.css" rel="stylesheet">
    <link href="/css/prettify.css" rel="stylesheet">
    <link href="/css/customize.css" rel="stylesheet">

    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="/js/html5shiv.min.js"></script>
    <![endif]-->

    <!-- Fav and touch icons -->
    <!--<link rel="apple-touch-icon-precomposed" sizes="144x144" href="../assets/ico/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="../assets/ico/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="../assets/ico/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="../assets/ico/apple-touch-icon-57-precomposed.png">-->
    <link rel="shortcut icon" href="/favicon.ico">
  </head>
  <body onload="prettyPrint()">
    <div id="wrap">

	<!-- Fixed navbar -->
    <div class="navbar navbar-default navbar-fixed-top" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="/index.html">IT Gumby's blog</a>
        </div>
        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li><a href="/archive.html">Archive</a></li>
            <li><a href="/presentations.html">Presentations</a></li>
            <li><a href="/about.html">About Me</a></li>
            <li><a href="/feed.xml">RSS</a></li>
            <li><a href="https://github.com/itgumby">GitHub<i class="fa fa-github"></i></a></li>
            <li><a href="https://twitter.com/itgumby">Twitter<i class="fa fa-twitter"></i></a></li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </div>
    <div class="container">
	<div class="page-header"><h1>Blog</h1></div>
  			<a href="blog/2014/simple-soap-example.html"><h1>Simple SOAP Example</h1></a>
  			<p>23 October 2014</p>
			<p>
				<em>Tags: </em>
					<a href="/tags/groovy.html">groovy</a> 
					<a href="/tags/SOAP.html">SOAP</a> 
			</p>
  			<p><div class="paragraph">
<p>All I wanted was a JVM-based script exemplifying a simple SOAP call.
However, I wasn&#8217;t satisfied with their complexity and pieces.</p>
</div>
<div class="paragraph">
<p>Best practices have established using a <a href="http://docs.spring.io/spring-ws/site/reference/html/why-contract-first.html">contract-first</a> approach is more reliable and resilient.
Spring also documented the prototypical Java SOAP client: <a href="http://spring.io/guides/gs/consuming-web-service/">Consuming a SOAP web service</a>.
The example has a clear classes &amp; separation of concerns, but still requires a build file to generate code from the WSDL using JAXB.</p>
</div>
<div class="sect1">
<h2 id="_my_simple_example_in_groovy">My Simple Example: in Groovy</h2>
<div class="sectionbody">
<div class="paragraph">
<p>My example breaks the client into 3 parts:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Creating the Request</p>
</li>
<li>
<p>Get the Response</p>
</li>
<li>
<p>Extracting Data</p>
</li>
</ol>
</div>
<div class="sect2">
<h3 id="_creating_the_request">Creating the Request</h3>
<div class="paragraph">
<p>The traditional approach creates an object, then marshalls it (converts object to a string).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">String buildRequest(String zip) {
    def writer = new StringWriter()
    def builder = new MarkupBuilder(writer)

    builder.GetCityForecastByZIP(xmlns: "http://ws.cdyne.com/WeatherWS/") {
        ZIP(zip)
    }
    return writer.toString()
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Groovy&#8217;s <a href="http://groovy.codehaus.org/Creating+XML+using+Groovy&#8217;s+MarkupBuilder">MarkupBuilder</a> makes it super easy to safely build XML (or HTML).
It can handle attributes, escaping content, and even namespaces!
The XML is patterned from the WSDL&#8217;s Request object manually, or using <a href="http://www.soapui.org/">SoapUI</a> to build it from the WSDL.</p>
</div>
</div>
<div class="sect2">
<h3 id="_get_the_response">Get the Response</h3>
<div class="paragraph">
<p>Both examples use Spring&#8217;s WebServiceTemplate methods.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">String callSoapWeather(String body) {
    def msgFactory = new SaajSoapMessageFactory()
    msgFactory.afterPropertiesSet()

    def wsTemplate = new WebServiceTemplate(msgFactory)
    wsTemplate.setDefaultUri("http://wsf.cdyne.com/WeatherWS/Weather.asmx")

    def writer = new StringWriter()
    try {
        wsTemplate.sendSourceAndReceiveToResult(
            new StringSource(body),
            new SoapActionCallback("http://ws.cdyne.com/WeatherWS/GetCityForecastByZIP"),
            new StreamResult(writer)
        )
    } catch (Exception e) { println "ERROR: ${e.message} - ${e.cause}" }
    return writer.toString()
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Spring&#8217;s <a href="http://docs.spring.io/spring-ws/site/reference/html/client.html">WebServices and Templates</a> handles calling the SOAP service, callback status and converting the response stream back into a string.</p>
</div>
</div>
<div class="sect2">
<h3 id="_extracting_data">Extracting Data</h3>
<div class="paragraph">
<p>Instead of unmarshalling (converting a string to an object):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">void printResults(String response) {
    final xml = new XmlSlurper().parseText(response)
    def nodes = xml.GetCityForecastByZIPResult
    println "Forecast for ${nodes.City}, ${nodes.State}"

    def format = new SimpleDateFormat("yyyy-MMM-dd")
    nodes.ForecastResult.children().each { forecast -&gt;
        def inDate = new Date().parse("yyyy-MM-dd'T'HH:mm:ss", forecast.Date as String)
        println "${format.format(inDate)} ${forecast.Description} ${forecast.Temperatures.MorningLow} - ${forecast.Temperatures.DaytimeHigh}"
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Groovy&#8217;s <a href="http://groovy.codehaus.org/Reading+XML+using+Groovy&#8217;s+XmlSlurper">XmlSlurper</a> takes the place of traditional JAXB unmarshalling.
Instead of mapping XML into Objects, XmlSlurper parses the string into Nodes and <a href="http://groovy.codehaus.org/api/groovy/util/slurpersupport/GPathResult.html">GPathResults</a>.
As long as the names of the nodes you need don&#8217;t change, you can name the path to the data, or even <code>.depthFirst().collect{ it }.findAll{ it.name() == "NODE_NAME" }</code> which allows the path to change and still work.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>SOAP doesn&#8217;t have to be intimidating on the JVM platform.
I hope others find the contrast with the traditional JAXB approach informative.
My full working <a href="https://gist.github.com/ItGumby/3fe5c317dc4c898c133c">SimpleSoap.groovy</a> is posted as a single file in a gist.</p>
</div>
</div>
</div></p>
  			<a href="blog/2014/cq-queries-demystified.html"><h1>CQ Queries Demystified</h1></a>
  			<p>09 October 2014</p>
			<p>
				<em>Tags: </em>
					<a href="/tags/CQ5-AEM.html">CQ5-AEM</a> 
					<a href="/tags/JCR.html">JCR</a> 
					<a href="/tags/Queries.html">Queries</a> 
			</p>
  			<p><div class="paragraph">
<p>The JCR (Java Content Repository) is a data-store at its heart.  Most examples around it demonstrate either building components or walking the Node tree.  It is hard to find examples around queries and the JCR.  To make things worse, we have a number of options and little resourcs to compare them.  My humble goal is to make JCR queries less scary - to myself and others.</p>
</div>
<div class="sect1">
<h2 id="_why_use_queries">Why Use Queries?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>I see 2 primary benefits to using queries compared to "walking the nodes": efficiency and flexibility.</p>
</div>
<div class="paragraph">
<p>Queries can be <strong>more efficient</strong> when the desired nodes/pages are "sparse".  By sparse, I mean you have to visit a lot more nodes than you keep.  In my recent experience, I was looking for approximately 200-300 pages out of 2,000.  Converting from page traversal to a query improved performance by an order of magnitude (from approximately 10 sec. to well under a second.)</p>
</div>
<div class="paragraph">
<p>Queries also permit <strong>flexibility in structure</strong>.  <a href="http://wiki.apache.org/jackrabbit/DavidsModel#Rule_.231">David&#8217;s Rules</a> encourage prioritizing content over formal structure.  If walking the tree of nodes or pages, a developer may limit depth of searching (either a flat level or limited recursion) for simplicity of code and/or performance.  However, in a CMS environment, there are tremendous benefits for authors when they can create an arbitrary taxonomy around their data or pages.</p>
</div>
<div class="paragraph">
<p>There are two primary APIs for Querying in CQ5:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>javax.jcr.query</code> provides a query interface API in a variety of syntaxes.  <a href="http://www.day.com/specs/javax.jcr/javadocs/jcr-2.0/javax/jcr/query/QueryResult.html">QueryResult</a> can return <a href="http://www.day.com/specs/javax.jcr/javadocs/jcr-2.0/javax/jcr/NodeIterator.html">NodeIterators</a> or <a href="http://www.day.com/specs/javax.jcr/javadocs/jcr-2.0/javax/jcr/query/RowIterator.html">RowIterators</a> (where a <a href="http://www.day.com/specs/javax.jcr/javadocs/jcr-2.0/javax/jcr/query/Row.html">Row</a> can have 1 or more columns. Columns can be http://www.day.com/specs/javax.jcr/javadocs/jcr-2.0/javax/jcr/Node.html[Node] node,  http://www.day.com/specs/javax.jcr/javadocs/jcr-2.0/javax/jcr/Value.html[Value] property, String path or double score).</p>
</li>
<li>
<p><code>com.day.cq.search</code> provides both a REST interface and an API.  The <a href="http://docs.adobe.com/docs/en/aem/6-0/develop/ref/javadoc/com/day/cq/search/result/SearchResult.html">SearchResult</a> can return Iterator&lt;Resource&gt;, Iterator&lt;Node&gt;, or List&lt;http://docs.adobe.com/docs/en/aem/6-0/develop/ref/javadoc/com/day/cq/search/result/ResultPage.html[ResultPage]&gt; that match the Predicates.</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_preconditions">Preconditions</h3>
<div class="paragraph">
<p>CQ5 searches are "powered by" <a href="http://lucene.apache.org/">Apache Lucene</a> (although AEM6 is converting to <a href="http://lucene.apache.org/solr/">Apache Solr</a>).  An important limitation is that indexing only examines Node properties that are 16KB or less in size - so anything larger won&#8217;t be found by any searching mechanism.</p>
</div>
<div class="paragraph">
<p>Internally, the queries are converted to an AQM (Abstract Query Model).  The interesting aspect about AQM is the ability to create new query syntaxes and predicates - but that is well beyond the scope of this post.</p>
</div>
</div>
<div class="sect2">
<h3 id="_nodetypes">NodeTypes</h3>
<div class="paragraph">
<p>I recommend paying attention to the <a href="http://jackrabbit.apache.org/node-type-visualization.html">NodeType</a> you use.  At the top of the hierarchy tree is <code>nt:base</code>, (so all nodes inherit from it).  Because of this inheritance, most examples show using it as a "works anywhere" approach.  However, I feel this is a poor approach and you would be better served selecting a more appropriate type (<code>jcr:primaryType</code> property of your desired nodes).  I would like to highlight:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>cq:Page</code> to match just <a href="http://dev.day.com/docs/en/cq/current/javadoc/com/day/cq/wcm/api/Page.html">Page</a> nodes</p>
</li>
<li>
<p><code>cq:PageContent</code> to easily convert to <a href="http://dev.day.com/docs/en/cq/current/javadoc/com/day/cq/commons/inherit/InheritanceValueMap.html">InheritanceValueMap</a> or <a href="http://dev.day.com/docs/en/cq/current/javadoc/org/apache/sling/api/resource/ValueMap.html">ValueMap</a></p>
</li>
<li>
<p><code>nt:unstructured</code> to find content nodes for generic components or content</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_jcr_queries_a_href_http_www_day_com_specs_javax_jcr_javadocs_jcr_2_0_javax_jcr_query_query_html_javax_jcr_query_a">JCR Queries: <a href="http://www.day.com/specs/javax.jcr/javadocs/jcr-2.0/javax/jcr/query/Query.html">javax.jcr.query</a></h2>
<div class="sectionbody">
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 1. jcr.query Syntaxes</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 40%;">
<col style="width: 40%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Syntax</th>
<th class="tableblock halign-left valign-top">Cons</th>
<th class="tableblock halign-left valign-top">Pros</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://jackrabbit.apache.org/api/2.2/org/apache/jackrabbit/commons/query/sql2/package-summary.html">SQL2</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">poor documentation<br>
no sub-queries<br>
limited joins<br>
new functions</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"looks" like a query<br>
limited joins (K.I.S.S. principle)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://jackrabbit.apache.org/api/2.2/org/apache/jackrabbit/spi/commons/query/xpath/package-summary.html">XPath</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"strange" syntax (<a href="http://zvon.org/comp/r/tut-XPath_1.html#intro">Tutorials exist</a>)<br>
deprecated in JCR2.0 (yet still supported)<br>
many XPath functions missing</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">maturity &amp; performance<br>
generic (outside JCR) solution for structure/nodes/attributes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://www.day.com/maven/javax.jcr/javadocs/jcr-2.0/javax/jcr/query/qom/QueryObjectModelFactory.html?is-external=true">JQOM</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">poor documentation</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">build own query language/API</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SQL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">no longer supported</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N/A</p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="title">Query Example</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-jsp" data-lang="jsp">&lt;%--
  JCR Query API component.
  Component for dumping list of components found
--%&gt;&lt;%@page session="false" %&gt;
&lt;%@include file="/libs/foundation/global.jsp"%&gt;
&lt;%@page import="javax.jcr.query.Query, java.util.Iterator" %&gt;
&lt;h2&gt;Components from javax.jcr.query&lt;/h2&gt;
&lt;ul&gt;
    &lt;li&gt;# &lt;strong&gt;Component Title&lt;/strong&gt; path&lt;/li&gt;
&lt;%
    // final String xpath = "/jcr:root/apps//element(*, cq:Component) order by @jcr:title";
    // Iterator&lt;Resource&gt; rscIterator = resourceResolver.findResources(xpath, Query.XPATH);
    final String sql2 = "SELECT * FROM [cq:Component] AS c WHERE ISDESCENDANTNODE([/apps]) ORDER BY lower(c.[jcr:title])";
    Iterator&lt;Resource&gt; rscIterator = resourceResolver.findResources(sql2, Query.JCR_SQL2);
%&gt;
  &lt;c:forEach var="compRsc" items="&lt;%= rscIterator %&gt;" varStatus="i"&gt;
    &lt;%-- conversion steps to aid in getting Resource properties --%&gt;
    &lt;c:set var="compProps" value="&lt;%= ((Resource)pageContext.getAttribute("compRsc")).adaptTo(ValueMap.class) %&gt;" /&gt;
    &lt;li&gt;${i.count}: &lt;strong&gt;${compProps['jcr:title']}&lt;/strong&gt; ${compRsc.path}&lt;/li&gt;
  &lt;/c:forEach&gt;
&lt;/ul&gt;</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
Prefer Resource over Node.  It has a cleaner, easier to use API.
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
Leverage JSP Expression Language &amp; <a href="http://www.tutorialspoint.com/jsp/jsp_standard_tag_library.htm">JSTL</a> to keep the JSP Template simple &amp; clear.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_querybuilder_api_a_href_http_docs_adobe_com_docs_en_cq_current_javadoc_com_day_cq_search_package_summary_html_com_day_cq_search_a">QueryBuilder API: <a href="http://docs.adobe.com/docs/en/cq/current/javadoc/com/day/cq/search/package-summary.html">com.day.cq.search</a></h2>
<div class="sectionbody">
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 2. QueryBuilder Syntaxes</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 40%;">
<col style="width: 40%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Syntax</th>
<th class="tableblock halign-left valign-top">Cons</th>
<th class="tableblock halign-left valign-top">Pros</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://docs.adobe.com/docs/en/aem/6-0/develop/ref/javadoc/com/day/cq/search/QueryBuilder.html">Java API</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">More code to setup<br>
node property values must be extracted (just like JCR Queries)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Iterators for Resources, Nodes (your choice)<br>
Lists of Pages (natural for search results pages)<br>
Predicates make "sense" as search conditions</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">"RESTful" interface at <a href="http://docs.adobe.com/docs/en/aem/6-0/develop/search/querybuilder-api.html">/bin/querybuilder.json</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">grouping predicates is more complex (naming predicates)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">dynamic at runtime<br>
documented examples of multi properties/values/nesting<br>
easy to test/explore via browser, curl</p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="title">Query Example</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-jsp" data-lang="jsp">&lt;%--
  CQ Query API component.
  Component for dumping list of components found
--%&gt;&lt;%@page session="false" %&gt;
&lt;%@include file="/libs/foundation/global.jsp"%&gt;
&lt;%@page import="java.util.*, com.day.cq.search.*, com.day.cq.search.result.*" %&gt;
&lt;h2&gt;Components from com.day.cq.search (QueryBuilder)&lt;/h2&gt;
&lt;ul&gt;
    &lt;li&gt;# &lt;strong&gt;Component Title&lt;/strong&gt; path&lt;/li&gt;
&lt;%
    Map&lt;String, String&gt; predicates = new HashMap&lt;String, String&gt;() {{
        put("path", "/apps");
        put("type", "cq:Component");
        put("orderby", "@jcr:title");
    }};

    QueryBuilder qb = resourceResolver.adaptTo(QueryBuilder.class);
    Session session = resourceResolver.adaptTo(Session.class);

    Query query = qb.createQuery(PredicateGroup.create(predicates), session);
    query.setHitsPerPage(0); // return ALL results
    Iterator&lt;Resource&gt; rscIterator = query.getResult().getResources();
%&gt;
  &lt;c:forEach var="compRsc" items="&lt;%= rscIterator %&gt;" varStatus="i"&gt;
    &lt;%-- conversion steps to aid in getting Resource properties --%&gt;
    &lt;c:set var="compProps" value="&lt;%= ((Resource)pageContext.getAttribute("compRsc")).adaptTo(ValueMap.class) %&gt;" /&gt;
    &lt;li&gt;${i.count}: &lt;strong&gt;${compProps['jcr:title']}&lt;/strong&gt; ${compRsc.path}&lt;/li&gt;
  &lt;/c:forEach&gt;
&lt;/ul&gt;</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
JSPs are best kept as templates with little to no Java in them.  In practice,
move the Java to an OSGi-managed class (Model).  If built outside of CQ5, this permits
rapid unit testing and potentially other JVM languages such as groovy.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>REST Example: <a href="http://localhost:4502/bin/querybuilder.json?type=cq:Component&amp;path=/apps&amp;orderby=@title&amp;orderby.sort=asc" class="bare">http://localhost:4502/bin/querybuilder.json?type=cq:Component&amp;path=/apps&amp;orderby=@title&amp;orderby.sort=asc</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_other_resources">Other Resources</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="https://wiki.magnolia-cms.com/display/WIKI/JCR+Query+Cheat+Sheet">JCR+Query+Cheat+Sheet</a> for comparing syntaxes</p>
</li>
<li>
<p><a href="http://labs.sixdimensions.com/blog/2014-10-07/9-jcr-sql-2-queries-every-aem-dev-should-know/">9 JCR-SQL2 Queries Every AEM Developer Should Know</a> by Dan Klco</p>
</li>
<li>
<p><a href="http://helpx.adobe.com/experience-manager/kb/HowToDebugJCRQueries.html">HowToDebugJCRQueries.html</a>
discusses adding loggers to a new file (separate from standard error.log) at the DEBUG level.
This logs the queries executed and their execution time.</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_sql2_functions_from_a_href_http_www_day_com_specs_jcr_2_0_6_query_html_6_6_2_20jcr_sql2_20notation_jcr_v2_0_spec_a">SQL2 functions (from <a href="http://www.day.com/specs/jcr/2.0/6_Query.html#6.6.2%20JCR-SQL2%20Notation">JCR v2.0 Spec</a>)</h3>
<div class="ulist">
<ul>
<li>
<p>CONTAINS(<em>propName</em>, <em>value</em>)</p>
</li>
<li>
<p>ISCHILDNODE() <em>immediate relationship</em></p>
</li>
<li>
<p>ISDESCENDANTNODE() <em>nested relationship</em></p>
</li>
<li>
<p>ISSAMENODE() <em>for join conditions</em></p>
</li>
<li>
<p>LENGTH(<em>propName</em>)</p>
</li>
<li>
<p>NAME()</p>
</li>
<li>
<p>LOCALNAME()</p>
</li>
<li>
<p>LOWER() <em>lower case the text</em></p>
</li>
<li>
<p>UPPER() <em>upper case the text</em></p>
</li>
<li>
<p>SCORE()</p>
</li>
<li>
<p>CAST(<em>literal</em> AS <em>type</em>)</p>
</li>
</ul>
</div>
</div>
</div>
</div></p>
  			<a href="blog/2014/cq-defineObjects-cheatsheet.html"><h1>CQ5 resource - &lt;cq:defineObjects/&gt; CheatSheet</h1></a>
  			<p>16 February 2014</p>
			<p>
				<em>Tags: </em>
					<a href="/tags/CQ5-AEM.html">CQ5-AEM</a> 
					<a href="/tags/JSP.html">JSP</a> 
			</p>
  			<p><div class="paragraph">
<p><a href="https://dev.day.com/docs/en/cq/current/developing/components.html#%3Ccq:defineObjects%3E">CQ5 Developing Components</a>
has a lot of information, but I wanted a handier cheat sheet.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 1. Objects from &lt;cq:defineobjects/&gt; (as of CQ5.6)</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">JavaDoc</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">my favorite methods</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>component</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://dev.day.com/docs/en/cq/current/javadoc/index.html?com/day/cq/wcm/api/components/Component.html">Component</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">the current AEM component object of the current resource</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">getName() / getPath()</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>componentContext</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://dev.day.com/docs/en/cq/current/javadoc/index.html?com/day/cq/wcm/api/components/ComponentContext.html">ComponentContext</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">the current component context object of the request</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">getPage() / getResource() / setDecorate(boolean)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>currentDesign</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://dev.day.com/docs/en/cq/current/javadoc/com/day/cq/wcm/api/designer/Design.html">Design</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">the current design object of the current page</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">getStaticCssPath() / getStyle(_) / writeCss(Writer, boolean) / writeCssIncludes(_)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>currentPage</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://dev.day.com/docs/en/cq/current/javadoc/com/day/cq/wcm/api/Page.html">Page</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">the current AEM WCM page object</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">getName() / getTitle() / getNavigationTitle() / getTags() / getContentResource() / getDepth() / getPageManager()</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>currentStyle</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://dev.day.com/docs/en/cq/current/javadoc/com/day/cq/wcm/api/designer/Style.html">Style</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">the current style object of the current cell</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>designer</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://dev.day.com/docs/en/cq/current/javadoc/com/day/cq/wcm/api/designer/Designer.html">Designer</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">the designer object used to access design information</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">getDesign(_) / getStyle(_)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>editContext</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://dev.day.com/docs/en/cq/current/javadoc/com/day/cq/wcm/api/components/EditContext.html">EditContext</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">the edit context object of the AEM component</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>pageManager</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://dev.day.com/docs/en/cq/current/javadoc/com/day/cq/wcm/api/PageManager.html">PageManager</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">the page manager object for page level operations</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">getPage(path) / create/ copy/ delete/ move/ order(_) / getRevisions(_)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>pageProperties</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://dev.day.com/docs/en/cq/current/javadoc/com/day/cq/commons/inherit/InheritanceValueMap.html">InheritanceValueMap</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">the page properties object of the current page</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">getInherited(name,default) / get(name,default) / put(key,val)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>properties</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://dev.day.com/docs/en/cq/current/javadoc/org/apache/sling/api/resource/ValueMap.html">ValueMap</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">the properties object of the current resource</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">get(name,defaultVal) / put(key,val) <a href="http://experiencedelivers.adobe.com/cemblog/en/experiencedelivers/2013/02/valuemap-and-his-friend.html">examples</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>resourceDesign</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://dev.day.com/docs/en/cq/current/javadoc/com/day/cq/wcm/api/designer/Design.html">Design</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">the design object of the resource page</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>see currentDesign</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>resourcePage</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://dev.day.com/docs/en/cq/current/javadoc/com/day/cq/wcm/api/Page.html">Page</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">the resource page object</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>see currentPage</em></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Attributes provided by <code>cq:defineObjects</code>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>componentContextName</code></p>
</li>
<li>
<p><code>componentName</code></p>
</li>
<li>
<p><code>currentDesignName</code></p>
</li>
<li>
<p><code>currentPageName</code></p>
</li>
<li>
<p><code>currentStyleName</code></p>
</li>
<li>
<p><code>designerName</code></p>
</li>
<li>
<p><code>editContextName</code></p>
</li>
<li>
<p><code>logName</code></p>
</li>
<li>
<p><code>nodeName</code></p>
</li>
<li>
<p><code>pageManagerName</code></p>
</li>
<li>
<p><code>pagePropertiesName</code></p>
</li>
<li>
<p><code>propertiesName</code></p>
</li>
<li>
<p><code>requestName</code></p>
</li>
<li>
<p><code>resourceDesignName</code></p>
</li>
<li>
<p><code>resourceName</code></p>
</li>
<li>
<p><code>resourcePageName</code></p>
</li>
<li>
<p><code>resourceResolverName</code></p>
</li>
<li>
<p><code>slingName</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The &lt;cq:defineObjects&gt; tag also automatically includes &lt;sling:defineObjects/&gt;</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 2. Objects from &lt;sling:defineObjects/&gt; (as of CQ5.6)</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">JavaDoc</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">my favorite methods</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>currentNode</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://www.day.com/maven/javax.jcr/javadocs/jcr-1.0/javax/jcr/Node.html">Node</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JCR node for current resource (not defined if not)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>discourage in favor of Resource or ValueMap</em> addNode(_) / getUUID()</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>log</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://www.slf4j.org/api/org/slf4j/Logger.html">SLF4J.Logger</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Provides an SLF4J Logger for logging to the Sling log system from within scripts</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">error / warn / info / debug</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>resource</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://dev.day.com/docs/en/cq/current/javadoc/org/apache/sling/api/resource/Resource.html">Resource</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">the current Resource object to handle (depending on the URL of the request)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">getName() / getPath() / getChild(path) / getChildren()</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>resourceResolver</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://dev.day.com/docs/en/cq/current/javadoc/org/apache/sling/api/resource/ResourceResolver.html">ResourceResolver</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The current ResourceResolver object</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">create(args) / commit() / getResource(_) / resolve(_) / queryResources(query, lang)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sling</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://dev.day.com/docs/en/cq/current/javadoc/index.html?org/apache/sling/api/scripting/SlingScriptHelper.html">SlingScriptHelper</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">convenience methods for scripts.  GOD Object.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">getService(Class) / include(_) / forward(_) / getRequest() / getResponse() / getScript()</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>slingRequest</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://dev.day.com/docs/en/cq/current/javadoc/org/apache/sling/api/SlingHttpServletRequest.html">SlingHttpServletRequest</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">extends <a href="http://docs.oracle.com/javaee/1.4/api/javax/servlet/http/HttpServletRequest.html">HttpServletRequest</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">getResource() / getCookie(name) / getRequestParameterMap() / getRequestParameters(name) / getRequestPathInfo()</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>slingResponse</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://dev.day.com/docs/en/cq/current/javadoc/org/apache/sling/api/SlingHttpServletResponse.html">SlingHttpServletResponse</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">extends <a href="http://docs.oracle.com/javaee/1.4/api/javax/servlet/http/HttpServletResponse.html">HttpServletResponse</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">static fields / addCookie(cookie) / getOutputStream() / getWriter()</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Attributes provided by <code>sling:defineObjects</code>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>logName</code></p>
</li>
<li>
<p><code>nodeName</code></p>
</li>
<li>
<p><code>requestName</code></p>
</li>
<li>
<p><code>resourceResolverName</code></p>
</li>
<li>
<p><code>responseName</code></p>
</li>
<li>
<p><code>slingName</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>I hope this helps others and myself.</p>
</div></p>
  			<a href="blog/2013/the-evolution-of-looping.html"><h1>The Evolution of Looping</h1></a>
  			<p>23 November 2013</p>
			<p>
				<em>Tags: </em>
					<a href="/tags/FP.html">FP</a> 
			</p>
  			<p><div class="sect1">
<h2 id="_tl_dr">TL;DR</h2>
<div class="sectionbody">
<div class="paragraph">
<p>There are two primary approaches to programming:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">imperative</dt>
<dd>
<p>the "classical" approach where the code describes <em>how</em> to accomplish something</p>
</dd>
<dt class="hdlist1">declarative</dt>
<dd>
<p>the "functional" approache where the code describes <em>what</em>  to accomplish</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>The evolution of looping remarks on the steps from looping in an imperative style to functional programming
that expresses intent and frees the language/compiler/machine to select potentially better
mechanisms of <em>how</em> to accomplish the task.  A tangible benefit of functional approaches
is code that expreses intent, which makes bugs easier to identify and solve.  It doesn&#8217;t
hurt that the lines of code can often get shorter.</p>
</div>
<div class="paragraph">
<p>My list of looping approaches (with un-official terms):</p>
</div>
<div class="ulist">
<ul>
<li>
<p>while/until</p>
</li>
<li>
<p>for with iterator</p>
</li>
<li>
<p>for each</p>
</li>
<li>
<p>forEach (functional)</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_examples">Examples</h2>
<div class="sectionbody">
<div class="paragraph">
<p>I started with examples written in JavaScript, but "for each" and "forEach" weren&#8217;t
as clear as examples written in other languages.  So I re-wrote the examples in Groovy,
a language related to Java that requires less boilerplate.</p>
</div>
<div class="listingblock">
<div class="title">while (or "until" to test at end of loop)</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">List&lt;Integer&gt; input = [1, 2, 3, 4, 5, 6, 7, 8, 9]
Integer sum = 0     // mutating sum

def i = 0               // iterator set to starting position of collection
def max = input.size()  // calculate end position once
while (i &lt; max) {       // test if continue looping
    def val = input[i]; // get value from array
    sum += val;         // change state of the sum
    i++;                // increment iterator
}
println "result of while() sum = ${sum}"</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">for loop</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">List&lt;Integer&gt; input = [1, 2, 3, 4, 5, 6, 7, 8, 9]
Integer sum = 0     // mutating sum

def max = input.size()          // calculate end position once
for (int i = 0; i &lt; max; i++) { // declare iterator, test &amp; increment statements
    def val = input[i];         // get value from array
    sum += val;                 // change state of the sum
}
println "result of for(;;) sum = ${sum}"</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">for each/in</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">List&lt;Integer&gt; input = [1, 2, 3, 4, 5, 6, 7, 8, 9]
Integer sum = 0     // mutating sum

for (Integer val : input) {
    sum += val
}
println "for(each) sum =&gt; ${sum}"</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">each (or "forEach" in Java8)</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">List&lt;Integer&gt; input = [1, 2, 3, 4, 5, 6, 7, 8, 9]
Integer sum = 0     // mutating sum

input.each { Integer val -&gt;  // explicitly declare type &amp; name; groovy defaults to "it"
    sum += val
}
println "[].each() sum =&gt; ${sum}"</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_trends">Trends</h3>
<div class="paragraph">
<p>The iterators started externally, then gradually moved internal to the loop, and finally disappeared.</p>
</div>
<div class="paragraph">
<p>The lines of code also dropped, although some of the intermediate steps had some busy lines.
For instance, for(;;) has the same work as the while() loop by essentially combining lines.</p>
</div>
<div class="paragraph">
<p>The general trend is from imperative (how) to declarative (what) code.
Less declarations for how to accomplish a task, the less opportunities for defects to be unintentionally introduced.
Also, the environment has more opportunities to optimize the solution, such as parallel processing.</p>
</div>
<div class="listingblock">
<div class="title">An example of a functional approach to summing (although most will provide a sum() function) can be:</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">List&lt;Integer&gt; input = [1, 2, 3, 4, 5, 6, 7, 8, 9]
def inputSum = input.inject(0, { acc, it -&gt; acc + it })     // most call it "reduce"
println inputSum</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_summary">Summary</h3>
<div class="ulist">
<ul>
<li>
<p>Favor declarative over imperative programming.</p>
</li>
<li>
<p>Use higher-level constructs in your language</p>
</li>
<li>
<p>Favor results over steps.  This leads to functional programming.</p>
</li>
<li>
<p>Prefer immutability over states &amp; transactions</p>
</li>
<li>
<p>final keyword in Java, Groovy to prevent changing state</p>
</li>
</ul>
</div>
</div>
</div>
</div></p>
	
	<hr />
	<p>Older posts are available in the <a href="archive.html">archive</a>.</p>
		</div>
		<div id="push"></div>
    </div>

    <div id="footer">
      <div class="container">
        <p class="muted credit">&copy; 2016 | Baked with <a href="http://jbake.org">JBake v2.4.0</a></p>
      </div>
    </div>

    <!-- Le javascript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="/js/jquery-1.11.1.min.js"></script>
    <script src="/js/bootstrap.min.js"></script>
    <script src="/js/prettify.js"></script>

  </body>
</html>
